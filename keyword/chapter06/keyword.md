## - 키워드 정리

#### - 지연로딩과 즉시로딩의 차이

- **즉시 로딩**

    - 연관된 엔티티를 즉시, 같이 한 번에 조회한다.

    - 객체를 조회하는 순간 연관 객체도 함께 로딩된다.

    - 장점

        - 조회 성능이 일관된다.

        - N + 1 문제가 발생하지 않는다.

    - 단점

        - 불필요한 JOIN이 발생한다.

        - 쿼리 복잡도가 증가한다.

        - 양방향 연관관계에서 무한 로딩이 발생할 수 있다.

- **지연 로딩**

    - 연관된 엔티티를 **실제로 사용할 때까지 조회를 미룬다.**

    - 연관된 엔티티는 프록시 객체로 채워진다.

    - 장점

        - 불필요한 JOIN 없이 필요한 데이터만 가져오므로 성능이 최적화된다.

        - 유연하게 제어할 수 있다.

    - 단점

        - N + 1 문제가 발생할 수 있다.

        - 트랜잭션 밖에서 지연로딩된 객체에 접근하면 예외가 발생할 수 있다.

-> **실무에서는 항상 LAZY로 설정하고, 필요한 곳만 Fetch Join을 적용한다.**

#### - Fetch Join

- JPA에서 지연로딩 설정된 연관관계를 한 번의 쿼리로 같이 가져오기 위해 사용하는 방법

- 일반 Join은 영속성 컨텍스트에 반영되지 않지만, **Fetch Join은 조인한 결과를 영속성 컨텍스트에 등록까지 해준다.**

- Fetch Join을 사용하면 지연 로딩으로 했을 때의 장점을 가져가면서, N + 1 문제를 해결할 수 있다.

- 주의점

    - 중복 데이터 문제가 발생한다. (1:N 관계면 N개의 데이터 생성)

    - 페이징이 불가능하다.

    - 2개 이상 Fetch Join시 오류 혹은 성능 저하가 발생한다.

#### - @EntityGraph

- JPA에서 지연로딩으로 설정된 연관 엔티티를 명시적으로 즉시 로딩하도록 지시하는 어노테이션

- Fetch Join과 똑같은 쿼리가 나간다.

- 사용 예시

  ``` java
  @EntityGraph(attributePaths = {"team"})
  List<Member> findAll();  // Member와 team을 한방에 로딩
  ```

- 주의점

    - Fetch Join과 마찬가지로, 페이징이 불가능하다.

#### - JPQL

- Java 객체(Entity)를 기준으로 작성하는 쿼리 언어

- Java Persistence Query Language

- 테이블과 컬럼이 아닌, 엔티티와 필드를 대상으로 쿼리를 작성한다.

- 사용 예시

  ``` java
  @Query("SELECT m FROM Member m JOIN m.team t WHERE t.name = :teamName")
  List<Member> findByTeamName(@Param("teamName") String teamName);
  ```

#### - QueryDSL

- 자바 코드로 SQL과 유사한 쿼리를 타입 안전하게 작성하게 해줄 수 있는 DSL(Domain Specific Language)

- 사용 예시

  ``` java
  query.select(
     Projections.constructor(MemberDto.class,
        m.username,
        m.age))
     .from(m)
     .fetch();
  ```

#### - JPQL vs QueryDSL

- **JPQL**

    - 장점

        - 코드가 간결하다.

        - JPA 공식 스펙에 포함되어 있다.

        - 별도의 라이브러리를 설치하지 않아도 된다.

        - 빠르게 익힐 수 있다.

    - 단점

        - 오타, 필드명 오류 등이 **컴파일 타임이 아닌 런타임 에러로 발생한다.**

        - **동적 쿼리를 작성하기가 힘들다.**

        - IDE 자동완성 지원이 잘 되지 않는다.

        - 엔티티 구조가 바뀌면 문자열을 다 찾아서 수정해야 한다.

- **QueryDSL**

    - 장점

        - **컴파일 타임에 문법, 필드명, 타입 체크가 가능하다.**

        - IDE 자동완성이 지원된다.

        - 동적 쿼리를 쉽게 작성할 수 있다.

        - 페이징/서브쿼리도 지원한다.

    - 단점

        - 별도의 라이브러리 설치 및 설정이 필요하다.

        - 문법/구조를 익혀야 한다.

        - 간단한 쿼리를 작성할 때도 길이가 조금 길어진다.

-> **간단한 조회 쿼리는 JPQL로**, **복잡한 동작 쿼리, 타입 안정성이 중요하면 QueryDSL**을 사용하자.
  